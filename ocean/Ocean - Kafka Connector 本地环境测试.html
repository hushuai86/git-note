<attachment contenteditable="false" data-atts="%5B%5D" data-aid=".atts-963c6ba1-1767-4d58-8eb8-f411a728476c"></attachment><h1>Ocean - Kafka Connector 本地环境测试Ocean - Kafka Connector 本地环境测试</h1><p>1.启动kafka</p><p><br></p><p>2.创建必要的topic</p><p>bin\windows\kafka-topics.bat --create --zookeeper localhost:2181 --replication-factor 1 --partitions 10 --topic devices</p><p>bin\windows\kafka-topics.bat --create --zookeeper localhost:2181 --replication-factor 1 --partitions 10 --topic devicesKTable</p><p>bin\windows\kafka-topics.bat --create --zookeeper localhost:2181 --replication-factor 1 --partitions 10 --topic telemetry</p><p>bin\windows\kafka-topics.bat --create --zookeeper localhost:2181 --replication-factor 1 --partitions 10 --topic agentAlert</p><p>bin\windows\kafka-topics.bat --create --zookeeper localhost:2181 --replication-factor 1 --partitions 10 --topic hallAlarm</p><p>bin\windows\kafka-topics.bat --create --zookeeper localhost:2181 --replication-factor 1 --partitions 10 --topic floorAlarm</p><p>bin\windows\kafka-topics.bat --create --zookeeper localhost:2181 --replication-factor 1 --partitions 10 --topic buildingAlarm</p><p>bin\windows\kafka-topics.bat --create --zookeeper localhost:2181 --replication-factor 1 --partitions 10 --topic siteAlarm</p><p>bin\windows\kafka-topics.bat --create --zookeeper localhost:2181 --replication-factor 1 --partitions 10 --topic hallTelemetry</p><p>bin\windows\kafka-topics.bat --create --zookeeper localhost:2181 --replication-factor 1 --partitions 10 --topic buildingTelemetry</p><p>bin\windows\kafka-topics.bat --create --zookeeper localhost:2181 --replication-factor 1 --partitions 10 --topic siteTelemetry</p><p>bin\windows\kafka-topics.bat --create --zookeeper localhost:2181 --replication-factor 1 --partitions 10 --topic telemetry_consolidate</p><p>bin\windows\kafka-topics.bat --create --zookeeper localhost:2181 --replication-factor 1 --partitions 10 --topic telemetry_60s</p><p>bin\windows\kafka-topics.bat --create --zookeeper localhost:2181 --replication-factor 1 --partitions 10 --topic telemetry_300s</p><p>bin\windows\kafka-topics.bat --create --zookeeper localhost:2181 --replication-factor 1 --partitions 10 --topic telemetry_900s</p><p>bin\windows\kafka-topics.bat --create --zookeeper localhost:2181 --replication-factor 1 --partitions 10 --topic telemetry_3600s</p><p>bin\windows\kafka-topics.bat --create --zookeeper localhost:2181 --replication-factor 1 --partitions 10 --topic telemetry_86400s</p><p><br></p><p>3.编译打包kakfa-connect project,,并把 mysql-connect 和 cassandra-connect ,redis-connect的zip 解压到某个目录下，例如：</p><p><img src="//:0"></p><p><br></p><p>4.修改connect-distributed.properties</p><p>key.converter=org.apache.kafka.connect.storage.StringConverter</p><p>value.converter=org.apache.kafka.connect.json.JsonConverter</p><p>key.converter.schemas.enable=false</p><p>value.converter.schemas.enable=false</p><p><br></p><p>#添加plugin.path配置，指向connctor 所在目录</p><p>plugin.path=D:\\plugins\\kafka-connect-mysql,D:\\plugins\\kafka-connect-cassandra,D:\\plugins\\kafka-connect-redis</p><p><br></p><p>5.启动 kafka&nbsp;connector distrubate</p><p>bin\windows\connect-distributed.bat config\connect-distributed.properties</p><p><br></p><p><strong>MySql Connector&nbsp;</strong></p><p><br></p><p>1.打开git bash 窗口，创建 mysql 的 connector</p><p>#记得修改mysql url ,user，password</p><p>curl -s -X POST -H "Content-Type: application/json" --data '{</p><p>&nbsp;&nbsp;&nbsp;"name":"mysql-sink",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;"config":{</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"connector.class":"com.accentrix.kafka.connect.mysql.MysqlSinkConnector",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"tasks.max":"1",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"topics":"devices",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"connection.url":"jdbc:mysql://localhost:3306/ocean-dev",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"connection.user":"root",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"connection.password":"!qw2#er4",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"max.retries":"10",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"retry.backoff.ms":"3000"</p><p>&nbsp;&nbsp;&nbsp;&nbsp;}</p><p>}' http://localhost:8083/connectors/</p><p><br></p><p>2. 创建 devices producer 并发送 devices 的message,device 和measurePoint 的数据,数据将被Connecotr保存到mysql DB 中.</p><p><span style="color: rgb(51, 51, 51);"># 创建指定Key 的&nbsp;device producer</span></p><p>bin\windows\kafka-console-producer.bat --broker-list localhost:9092 --topic device --property parse.key=true --property key.separator=:</p><p><br></p><p># message format&nbsp;</p><p>"4":{"ipAddress":"192.168.95.34","messageId":"8d25f387-a880-4335-83a6-f80b4e3d0b2c","description":"","groups":[],"deviceId":"4","deviceName":"DCT2_RF_MRS-COC-52A1-01","equipmentId":"MRS","building":"DCT2","roomId":"COC-52A1","subId":"01","protocol":"SNMP","slaveId":"1","action":"update","siteId":"TKO","floor":"RF","ts":1594422449470,"telemetries":[{"unit":"C","alarms":"","name":"Temperature","description":"Temperature","interval":"5000"},{"unit":"%","alarms":"","name":"Humidity","description":"Humidity","interval":"5000"},{"unit":"","alarms":"","name":"DewPoint","description":"Dew Point","interval":"5000"}]}</p><p><br></p><p><br></p><p><strong>Redis Connector</strong></p><p>1.启动 Redis</p><p><br></p><p>2.启动Cassandra DB,创建namespace 和 table</p><p><br></p><p>3.打开git bash 窗口，创建 mysql 的 connector</p><p>curl http://localhost:8083/connectors/ -X POST -i -H "Content-Type:application/json" -d '{</p><p>&nbsp;&nbsp;&nbsp;"name":"redis-sink",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"config":{</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"name":"redis-sink",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"connector.class" : "com.github.jcustenborder.kafka.connect.redis.RedisSinkConnector",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"topics":"telemetry",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"redis.client.mode":"Sentinel",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"redis.auto.reconnect.enabled":"true",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"redis.hosts":"127.0.0.1:26379",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"redis.masterId":"master",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"redis.database":"0",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"tasks.max":"1",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"key.converter":"org.apache.kafka.connect.storage.StringConverter",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"value.converter":"org.apache.kafka.connect.storage.StringConverter",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"redis.database":"0"</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p><p>}'</p><p><br></p><p>4. 创建 telemetry producer 并发送 telemetry 的message, Telemetrye的数据将被Connecotr保存到 Redis中.</p><p><span style="color: rgb(51, 51, 51);"># 创建指定Key 的&nbsp;telemetry producer</span></p><p>bin\windows\kafka-console-producer.bat --broker-list localhost:9092 --topic telemetry --property parse.key=true --property key.separator=:</p><p><br></p><p># message format</p><p>"3-MAXDEMANDL1": {"agentId":"acda9848-34c5-42aa-8dfe-4fa60f12eda6","measurePoint":"MAXDEMANDL1","messageId":"850a3223-9df0-4fa5-85e4-6106890ccbea","deviceName":"DCT2_Lab_UMG509-Lab30-01","deviceId":"3","value":0,"ts":1594385719206}</p><p><br></p><p><br></p><p><strong>Cassandra Connector&nbsp;</strong></p><p><br></p><p>1.启动Cassandra DB,创建namespace 和 table</p><p>2.打开git bash 窗口，创建 cassandra的 connector</p><p>curl 'http:/localhost:8083/connectors' -X POST -i -H "Content-Type:application/json" -d '{</p><p>&nbsp;&nbsp;&nbsp;&nbsp;"name":"cassandra-sink",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;"config":{</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"connector.class":"com.accentrix.kafka.connect.cassandra.sink.CassandraSinkConnector",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"tasks.max":"10",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"topics":"telemetry,telemetry_60s,telemetry_300s,telemetry_900s,telemetry_3600s,telemetry_86400s",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"cassandra.host":"localhost",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"cassandra.port":"9042",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"cassandra.keyspace.name":"ocean",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"cassandra.username":"cassandra",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"cassandra.password":"cassandra",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"batch.size":"3000",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"max.retries":"1000000000",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"retry.backoff.ms":"3000",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"topics.valid.fields.telemetry":"messageId,agentId,deviceId,measurePoint,double_value,string_value,boolean_value,ts",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"topics.valid.fields.telemetry_60s":"deviceId,pointName,double_value,string_value,boolean_value,ts",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"topics.valid.fields.telemetry_300s":"deviceId,pointName,double_value,string_value,boolean_value,ts",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"topics.valid.fields.telemetry_900s":"deviceId,pointName,double_value,string_value,boolean_value,ts",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"topics.valid.fields.telemetry_3600s":"deviceId,pointName,double_value,string_value,boolean_value,ts",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"topics.valid.fields.telemetry_86400s":"deviceId,pointName,double_value,string_value,boolean_value,ts",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"ttl.telemetry":"14d",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"ttl.telemetry_60s":"2y",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"ttl.telemetry_300s":"2h",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"ttl.telemetry_900s":"2h",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"ttl.telemetry_3600s":"7y",</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"ttl.telemetry_86400s":"7d"</p><p>&nbsp;&nbsp;&nbsp;&nbsp;}</p><p>}'</p><p><br></p><p>3.启动ocean-stream-service</p><p><br></p><p>4. 创建 telemetry producer 并发送 telemetry 的message, Telemetry，telemetry,telemetry_300s,telemetry_900s,telemetry_3600s,telemetry_86400s,telemetry_consolidate的数据将被Connecotr保存到Cassandra DB 中.</p><p><span style="color: rgb(51, 51, 51);"># 创建指定Key 的&nbsp;telemetry producer</span></p><p>bin\windows\kafka-console-producer.bat --broker-list localhost:9092 --topic telemetry --property parse.key=true --property key.separator=:</p><p><br></p><p># message format</p><p>"3-MAXDEMANDL1": {"agentId":"acda9848-34c5-42aa-8dfe-4fa60f12eda6","measurePoint":"MAXDEMANDL1","messageId":"850a3223-9df0-4fa5-85e4-6106890ccbea","deviceName":"DCT2_Lab_UMG509-Lab30-01","deviceId":"3","value":0,"ts":1594385719206}</p><p><br></p><p>5.如果只是测试connector,则不需要启动 ocean-stream-service，可以直接发送到telemetry,telemetry_300s,telemetry_900s,telemetry_3600s,telemetry_86400s,telemetry_consolidate 任意一个topic</p><p>bin\windows\kafka-console-producer.bat --broker-list localhost:9092 --topic telemetry_consolidate --property parse.key=true --property key.separator=:</p><p><br></p><p>"4-Telemetry":{"measurePoint":"Temperature","deviceId":"4","avgValue":23.42,"minValue":23.42,"maxValue":23.42,"sum":23.42,"count":1,"thresholdConsolidationTime":900,"ts":"2020-07-11T07:08:38+0800"}</p><p><br></p><p><br></p><p><br></p>